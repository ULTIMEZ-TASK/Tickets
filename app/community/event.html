<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events.Coinpedia Strategy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- FIREBASE SDKs (Realtime Database Version) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, push, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- LIVE CONFIGURATION (Pre-filled with your credentials) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDd1_Wce_Fcyy6CuItjMPc1m943_lUnvik",
            authDomain: "ultimez-af865.firebaseapp.com",
            databaseURL: "https://ultimez-af865-default-rtdb.firebaseio.com", 
            projectId: "ultimez-af865",
            storageBucket: "ultimez-af865.firebasestorage.app",
            messagingSenderId: "1002546251476",
            appId: "1:1002546251476:web:8c787e70d8b6e3f8af9d41",
            measurementId: "G-N2JLJ5TG3N"
        };
        // -----------------------------------------------------------

        // Global State
        window.currentPlatform = '';
        window.currentTab = 'routine';
        window.dbData = {}; 

        const statusIndicator = document.getElementById('dbStatus');
        const statusText = document.getElementById('dbStatusText');

        // --- FIREBASE MODE (RTDB) ---
        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const tasksRef = ref(db, 'strategies/events_tracker_v1');
            
            // Real-time Listener
            onValue(tasksRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    window.dbData = data;
                    // Update UI if modal is open
                    if(document.getElementById('platformModal').classList.contains('active')) {
                        renderTasks();
                    }
                } else {
                    // Initialize empty if null
                    set(tasksRef, { _init: true });
                }
                
                // Success State
                if(statusIndicator) {
                    statusIndicator.className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75";
                    const dot = document.getElementById('dbStatusDot');
                    if(dot) dot.className = "relative inline-flex rounded-full h-3 w-3 bg-green-500";
                    
                    statusText.innerText = "Live RTDB";
                    statusText.className = "text-xs font-medium text-green-700";
                }
            }, (error) => {
                console.error("RTDB Error:", error);
                enableLocalFallback("Connection Failed");
            });

            // Write Functions
            window.toggleTaskDB = (id) => {
                const currentStatus = window.dbData[id]?.done || false;
                // RTDB uses path updates
                const updates = {};
                updates['strategies/events_tracker_v1/' + id + '/done'] = !currentStatus;
                if(!window.dbData[id]) updates['strategies/events_tracker_v1/' + id + '/note'] = ""; // Init note if missing
                
                update(ref(db), updates);
            };

            window.saveNoteDB = (id, noteValue) => {
                const updates = {};
                updates['strategies/events_tracker_v1/' + id + '/note'] = noteValue;
                // Ensure 'done' exists to prevent overwriting whole object if it doesn't exist
                if(!window.dbData[id]?.done) updates['strategies/events_tracker_v1/' + id + '/done'] = false; 
                
                update(ref(db), updates);
            };

            // NEW: Add Custom Task Function
            window.addNewTaskDB = () => {
                const taskText = document.getElementById('newTaskInput').value;
                const taskFreq = document.getElementById('newFreqSelect').value;

                if (!taskText.trim()) {
                    alert("Please enter a task description");
                    return;
                }

                const newId = `custom-${Date.now()}`;
                const updates = {};
                
                // Create the task object
                const newTask = {
                    task: taskText,
                    freq: taskFreq,
                    platform: window.currentPlatform,
                    tab: window.currentTab,
                    isCustom: true,
                    done: false,
                    note: ""
                };

                updates['strategies/events_tracker_v1/' + newId] = newTask;

                update(ref(db), updates).then(() => {
                    // Reset Form
                    document.getElementById('newTaskInput').value = "";
                    document.getElementById('addTaskForm').classList.add('hidden');
                    document.getElementById('addTaskBtn').classList.remove('hidden');
                }).catch((error) => {
                    console.error("Error adding task: ", error);
                    alert("Failed to add task.");
                });
            };

        } catch (e) {
            console.error("Firebase Init Failed:", e);
            enableLocalFallback("Init Error");
        }

        function enableLocalFallback(reason) {
            console.log(`Switching to LocalStorage. Reason: ${reason}`);
            
            if(statusIndicator) {
                statusIndicator.className = "absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75";
                const dot = document.getElementById('dbStatusDot');
                if(dot) dot.className = "relative inline-flex rounded-full h-3 w-3 bg-orange-500";
                
                statusText.innerText = `Offline (${reason})`;
                statusText.className = "text-xs font-medium text-orange-700";
            }

            const storedData = localStorage.getItem('events_tracker_v1');
            if (storedData) window.dbData = JSON.parse(storedData);

            window.toggleTaskDB = (id) => {
                const current = window.dbData[id] || { done: false, note: "" };
                window.dbData[id] = { ...current, done: !current.done };
                localStorage.setItem('events_tracker_v1', JSON.stringify(window.dbData));
                renderTasks();
            };

            window.saveNoteDB = (id, noteValue) => {
                const current = window.dbData[id] || { done: false, note: "" };
                window.dbData[id] = { ...current, note: noteValue };
                localStorage.setItem('events_tracker_v1', JSON.stringify(window.dbData));
            };
            
            window.addNewTaskDB = () => {
                alert("Adding new tasks is only available in Online Mode.");
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { opacity: 0; visibility: hidden; transition: all 0.2s ease-out; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95) translateY(10px); transition: all 0.2s ease-out; }
        .modal.active .modal-content { transform: scale(1) translateY(0); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hover-row:hover td { background-color: #f8fafc; }
        .note-input { background: transparent; border: 1px solid transparent; width: 100%; padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; transition: all 0.2s; }
        .note-input:focus { background: white; border-color: #cbd5e1; outline: none; }
        .note-input:hover { background: #f1f5f9; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg"><i data-lucide="calendar-days" class="w-5 h-5 text-white"></i></div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900 tracking-tight leading-none">Events.Coinpedia</h1>
                        <p class="text-xs text-slate-500 font-medium">Live Community Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                          <span id="dbStatus" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-gray-400 opacity-75"></span>
                          <span id="dbStatusDot" class="relative inline-flex rounded-full h-3 w-3 bg-gray-500"></span>
                        </span>
                        <span id="dbStatusText" class="text-xs font-medium text-slate-600">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase w-12">#</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Platform</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Focus</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Priority</th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200" id="mainTableBody">
                        <!-- Generated via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Task Modal -->
    <div id="platformModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col relative z-10 overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-start bg-white">
                <div class="flex items-center gap-4">
                    <div id="modalIconBg" class="w-12 h-12 rounded-xl flex items-center justify-center bg-blue-50">
                        <i id="modalIcon" data-lucide="layers" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div>
                        <h2 id="modalTitle" class="text-xl font-bold text-slate-900">Platform</h2>
                        <p class="text-xs text-slate-500 font-medium mt-0.5">Strategy Checklist</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <!-- Progress -->
            <div class="px-6 py-3 bg-slate-50/50 border-b border-slate-100">
                <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                    <span id="progressText">Loading...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-600 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex p-1 mx-6 mt-4 bg-slate-100 rounded-lg">
                <button id="tabRoutine" onclick="switchTab('routine')" class="flex-1 py-2 text-sm font-semibold rounded-md transition-all shadow-sm bg-white text-slate-900">Routine Tasks (Daily/Weekly)</button>
                <button id="tabSOPs" onclick="switchTab('sops')" class="flex-1 py-2 text-sm font-semibold rounded-md transition-all text-slate-500 hover:text-slate-700">Strategy SOPs (Monthly)</button>
            </div>

            <!-- Add Task UI -->
            <div class="mx-6 mt-4">
                <button id="addTaskBtn" onclick="toggleAddForm()" class="flex items-center gap-2 text-sm font-semibold text-blue-600 hover:text-blue-700 transition-colors">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Custom Task
                </button>
                
                <div id="addTaskForm" class="hidden mt-2 p-3 bg-slate-50 border border-slate-200 rounded-lg">
                    <div class="flex gap-2">
                        <input type="text" id="newTaskInput" placeholder="Enter task description..." class="flex-1 px-3 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:border-blue-500">
                        <select id="newFreqSelect" class="px-3 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:border-blue-500 bg-white">
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                            <option value="Ad-hoc">Ad-hoc</option>
                        </select>
                        <button onclick="addNewTaskDB()" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Add</button>
                        <button onclick="toggleAddForm()" class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Task List -->
            <div class="flex-1 overflow-y-auto p-0 custom-scrollbar bg-white mt-4">
                <table class="min-w-full divide-y divide-slate-100">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase w-16">No.</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Task</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase w-24">Freq</th>
                            <th class="px-6 py-3 text-center text-xs font-bold text-slate-500 uppercase w-20">Done?</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase w-64">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody" class="bg-white divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        const platforms = [
            { name: "LinkedIn", focus: "B2B & Organizer Growth", priority: "High", icon: "linkedin", color: "blue" },
            { name: "X (Twitter)", focus: "Hype & Attendees", priority: "High", icon: "twitter", color: "slate" },
            { name: "Email / Substack", focus: "The Calendar", priority: "Medium", icon: "mail", color: "orange" },
            { name: "YouTube", focus: "Coverage & Interviews", priority: "Medium", icon: "youtube", color: "red" },
            { name: "Discord", focus: "The Lobby", priority: "Medium", icon: "gamepad-2", color: "indigo" },
            { name: "CMC / Binance Sq", focus: "Distribution", priority: "High", icon: "layout-grid", color: "yellow" },
            { name: "Quora", focus: "SEO & Authority", priority: "SEO", icon: "help-circle", color: "red" },
            { name: "Instagram", focus: "Visual Hype", priority: "Medium", icon: "instagram", color: "pink" },
            { name: "WhatsApp / Telegram", focus: "Direct Alerts", priority: "High", icon: "phone", color: "green" },
            { name: "Gitter / GitHub", focus: "Hackathons", priority: "Niche", icon: "code-2", color: "purple" },
            { name: "Medium", focus: "Long-form Guides", priority: "SEO", icon: "book-open", color: "slate" },
            { name: "Reddit", focus: "Community Trust", priority: "Medium", icon: "message-circle", color: "orange" },
            { name: "Tumblr", focus: "Visuals & Aesthetics", priority: "Niche", icon: "image", color: "blue" },
            { name: "Facebook", focus: "Groups & Pages", priority: "Low", icon: "facebook", color: "blue" }
        ];

        const strategies = {
            "LinkedIn": {
                routine: [
                    { task: "Connect with 'Event Managers' & 'Marketing Directors'", freq: "Daily" },
                    { task: "Post 'Upcoming Events This Week' carousel", freq: "Weekly" },
                    { task: "Tag Event Organizers in 'Media Partner' posts", freq: "Ad-hoc" },
                    { task: "Share 'Speaker Spotlights' from listed events", freq: "Daily" },
                    { task: "Message organizers offering 'Featured' discounts", freq: "Weekly" }
                ],
                sops: [
                    { task: "Audit 'Lead Generation' forms for submissions", freq: "Monthly" },
                    { task: "Review 'Click-Through Rate' on listing links", freq: "Monthly" },
                    { task: "Plan 'Coinpedia Networking Night' side-events", freq: "Quarterly" },
                    { task: "Update Media Kit (Traffic stats/Reach)", freq: "Monthly" }
                ]
            },
            "X (Twitter)": {
                routine: [
                    { task: "Post 'Ticket Giveaway' contests", freq: "Weekly" },
                    { task: "Quote-tweet speakers with 'Can't wait!'", freq: "Daily" },
                    { task: "Live-tweet key quotes during conferences", freq: "Ad-hoc" },
                    { task: "Host Spaces: 'Pre-Event Hype' w/ organizers", freq: "Ad-hoc" },
                    { task: "Create 'Twitter Lists' of event attendees", freq: "Weekly" }
                ],
                sops: [
                    { task: "Monitor official event hashtags (#Token2049)", freq: "Daily" },
                    { task: "Update Pinned Tweet to 'Global Calendar'", freq: "Monthly" },
                    { task: "Verify 'Affiliate Link' tracking", freq: "Monthly" },
                    { task: "Plan 'Live Coverage' logistics", freq: "Monthly" }
                ]
            }
            // Add other platforms as needed based on previous context, truncated for brevity
        };

        // --- UI LOGIC ---
        
        // 1. Render Main Table
        const mainTable = document.getElementById('mainTableBody');
        platforms.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-100";
            tr.innerHTML = `
                <td class="px-6 py-4 text-sm text-slate-400 font-mono">${(i+1).toString().padStart(2,'0')}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="h-10 w-10 bg-${p.color}-100 rounded-lg flex items-center justify-center text-${p.color}-600">
                            <i data-lucide="${p.icon}" class="w-5 h-5"></i>
                        </div>
                        <div class="ml-4 font-bold text-slate-900">${p.name}</div>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-600">${p.focus}</td>
                <td class="px-6 py-4"><span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-${p.priority === 'High' ? 'green' : 'slate'}-100 text-${p.priority === 'High' ? 'green' : 'slate'}-800">${p.priority}</span></td>
                <td class="px-6 py-4 text-right"><button onclick="openModal('${p.name}')" class="text-blue-600 font-semibold hover:underline text-sm">View Strategy</button></td>
            `;
            mainTable.appendChild(tr);
        });

        // 2. Modal Logic
        function openModal(platform) {
            window.currentPlatform = platform;
            document.getElementById('modalTitle').innerText = platform;
            document.getElementById('platformModal').classList.add('active');
            switchTab('routine');
        }

        window.closeModal = () => {
            document.getElementById('platformModal').classList.remove('active');
            toggleAddForm(false); // Reset form visibility
        }

        window.toggleAddForm = (show) => {
            const form = document.getElementById('addTaskForm');
            const btn = document.getElementById('addTaskBtn');
            if (show === undefined) show = form.classList.contains('hidden');
            
            if (show) {
                form.classList.remove('hidden');
                btn.classList.add('hidden');
            } else {
                form.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }

        window.switchTab = (tab) => {
            window.currentTab = tab;
            // Update Tab UI
            const btnRoutine = document.getElementById('tabRoutine');
            const btnSOPs = document.getElementById('tabSOPs');
            if(tab === 'routine') {
                btnRoutine.className = "flex-1 py-2 text-sm font-semibold rounded-md transition-all shadow-sm bg-white text-slate-900 border border-slate-200";
                btnSOPs.className = "flex-1 py-2 text-sm font-semibold rounded-md transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";
            } else {
                btnRoutine.className = "flex-1 py-2 text-sm font-semibold rounded-md transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";
                btnSOPs.className = "flex-1 py-2 text-sm font-semibold rounded-md transition-all shadow-sm bg-white text-slate-900 border border-slate-200";
            }
            renderTasks();
        }

        window.renderTasks = () => {
            const tableBody = document.getElementById('taskTableBody');
            tableBody.innerHTML = '';
            
            // 1. Get Hardcoded Strategy Tasks
            const hardcodedList = strategies[window.currentPlatform] ? strategies[window.currentPlatform][window.currentTab] : [];
            const taskList = hardcodedList.map((t, i) => ({
                ...t,
                id: `${window.currentPlatform}-${window.currentTab}-${i}`.replace(/[^a-zA-Z0-9-]/g, ''),
                isCustom: false
            }));

            // 2. Get Custom Tasks from DB
            Object.keys(window.dbData).forEach(key => {
                const item = window.dbData[key];
                // Filter for current platform/tab and ensure it's a custom task (has 'task' text property stored)
                if (item.isCustom && item.platform === window.currentPlatform && item.tab === window.currentTab) {
                    taskList.push({
                        id: key,
                        task: item.task,
                        freq: item.freq,
                        isCustom: true
                    });
                }
            });
            
            let completedCount = 0;

            taskList.forEach((item, index) => {
                // Get Live Data Status/Note
                // If it's custom, the data is already in 'item' via DB fetch above, but we normalize access
                const dbEntry = window.dbData[item.id] || {};
                const isDone = dbEntry.done || false;
                const note = dbEntry.note || "";
                
                if (isDone) completedCount++;

                const tr = document.createElement('tr');
                tr.className = `hover-row transition-colors ${isDone ? 'bg-blue-50/50' : ''}`;
                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-slate-400 font-mono">${(index + 1).toString().padStart(2, '0')}</td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-700 ${isDone ? 'line-through text-slate-400' : ''}">
                        ${item.task}
                        ${item.isCustom ? '<span class="ml-2 text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">Custom</span>' : ''}
                    </td>
                    <td class="px-6 py-4 text-center"><span class="px-2 py-1 text-xs rounded-md font-medium bg-slate-100 text-slate-600">${item.freq || '-'}</span></td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex justify-center">
                            <div onclick="toggleTaskDB('${item.id}')" class="cursor-pointer w-5 h-5 rounded border-2 ${isDone ? 'bg-blue-600 border-blue-600' : 'bg-white border-slate-300'} flex items-center justify-center transition-all">
                                <i data-lucide="check" class="w-3.5 h-3.5 text-white ${isDone ? 'opacity-100' : 'opacity-0'}"></i>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <input type="text" class="note-input" placeholder="Add note..." value="${note}" onchange="saveNoteDB('${item.id}', this.value)">
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            // Update Progress
            const total = taskList.length;
            const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${completedCount}/${total} Tasks Completed`;
            document.getElementById('progressPercent').innerText = `${percent}%`;

            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        if(typeof lucide !== 'undefined') lucide.createIcons();
    </script>
</body>
</html>
